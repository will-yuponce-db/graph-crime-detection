# Databricks Asset Bundle Configuration
# Cross-Jurisdictional Investigative Analytics Demo
#
# Deploy with:
#   databricks bundle deploy -t dev
#   databricks bundle deploy -t prod
#
# Run pipeline:
#   databricks bundle run investigative_analytics_pipeline -t dev

bundle:
  name: investigative-analytics

# Variable definitions for environment-specific values
variables:
  catalog:
    description: Unity Catalog name for pipeline tables
    default: pubsec_geo_law
  schema:
    description: Schema name within the catalog
    default: demo
  notification_email:
    description: Email for job notifications
    default: "scott.johnson@databricks.com"

# Default workspace - uses CLI auth profile
workspace:
  profile: pubsec_buildathon

# Shared resource definitions
resources:
  pipelines:
    investigative_analytics_pipeline:
      name: "Investigative Analytics - ${bundle.target}"
      catalog: ${var.catalog}
      target: ${var.schema}
      libraries:
        - file:
            path: ./pipelines/data_generation_dlt.py
      serverless: true
      continuous: false
      photon: true
      channel: PREVIEW
      configuration:
        "spark.databricks.delta.preview.enabled": "true"
        "pipelines.numStreamRetryAttempts": "5"

  jobs:
    demo_pipeline_job:
      name: "Investigative Analytics Pipeline - ${bundle.target}"
      description: "Generates demo data and validates output for the investigative analytics demo"
      environments:
        - environment_key: serverless_env
          spec:
            client: "1"
      tasks:
        - task_key: run_pipeline
          pipeline_task:
            pipeline_id: ${resources.pipelines.investigative_analytics_pipeline.id}
            full_refresh: true
        - task_key: validate_data
          depends_on:
            - task_key: run_pipeline
          notebook_task:
            notebook_path: ./pipelines/validate_data_generation.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
          environment_key: serverless_env
      email_notifications:
        on_failure:
          - ${var.notification_email}
      tags:
        project: investigative-analytics
        environment: ${bundle.target}

# Environment-specific targets
targets:
  # Development environment
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/scott.johnson@databricks.com/pubsec-buildathon-team2/${bundle.target}
    variables:
      catalog: pubsec_geo_law
      schema: demo
    resources:
      pipelines:
        investigative_analytics_pipeline:
          development: true

  # Staging environment
  staging:
    mode: development
    workspace:
      root_path: /Workspace/Users/scott.johnson@databricks.com/pubsec-buildathon-team2/${bundle.target}
    variables:
      catalog: pubsec_geo_law
      schema: demo
    resources:
      pipelines:
        investigative_analytics_pipeline:
          development: true

  # Production environment
  prod:
    mode: production
    workspace:
      root_path: /Workspace/Users/scott.johnson@databricks.com/pubsec-buildathon-team2/${bundle.target}
    variables:
      catalog: investigative_analytics
      schema: demo
    resources:
      pipelines:
        investigative_analytics_pipeline:
          development: false
          channel: CURRENT
          notifications:
            - email_recipients:
                - ${var.notification_email}
              alerts:
                - on-failure
                - on-flow-failure
